name: Deploy Pillution Application
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # íƒ€ì„ì•„ì›ƒ ëŠ˜ë¦¼
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 60m  # ëª…ë ¹ íƒ€ì„ì•„ì›ƒ ëŠ˜ë¦¼
          script: |
            echo "$(date) - ğŸ”¹ SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!"
            cd ~/pillution
            
            echo "$(date) - ğŸ”¹ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°"
            export GIT_SSH_COMMAND="ssh -i ~/.ssh/github-key -o StrictHostKeyChecking=no"
            git pull origin main
            
            echo "$(date) - ğŸ”¹ ë°±ì—”ë“œ ë¹Œë“œ ë° ë°°í¬"
            cd student_backend
            chmod +x gradlew
            ./gradlew build -x test
            
            echo "$(date) - ğŸ”¹ ì‹¤í–‰ ì¤‘ì¸ JAR í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ"
            if [ -f ~/pillution/backend.pid ]; then
              pkill -F ~/pillution/backend.pid || true
              rm ~/pillution/backend.pid
            else
              pkill -f "java -jar.*student-0.0.1-SNAPSHOT.jar" || true
            fi
            
            echo "$(date) - ğŸ”¹ ë°±ì—”ë“œ ì‹¤í–‰"
            nohup java -jar build/libs/student-0.0.1-SNAPSHOT.jar --server.port=8080 > ~/pillution/backend.log 2>&1 &
            echo $! > ~/pillution/backend.pid
            sleep 3
            echo "$(date) - ğŸ”¹ ë°±ì—”ë“œ ë°°í¬ ì™„ë£Œ"
            
            echo "$(date) - ğŸ”¹ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œì‘"
            cd ../student_frontend || exit 1
            npm ci --prefer-offline --no-audit --legacy-peer-deps
            echo "$(date) - ğŸ”¹ npm íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ, ë¹Œë“œ ì‹œì‘"
            NODE_OPTIONS="--max-old-space-size=2048" npm run build
            echo "$(date) - ğŸ”¹ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì™„ë£Œ"
            
            echo "$(date) - ğŸ”¹ Nginx ì •ì  íŒŒì¼ ì—…ë°ì´íŠ¸ ì‹œì‘"
            sudo rm -rf /usr/share/nginx/html/*
            sudo cp -r dist/* /usr/share/nginx/html/
            sudo nginx -t && sudo systemctl restart nginx
            echo "$(date) - ğŸ”¹ ë°°í¬ ì™„ë£Œ!"
