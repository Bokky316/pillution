name: Deploy Student Application 
on: 
  push: 
    branches: 
      - main
jobs: 
  deploy: 
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps: 
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Fix SSH Key Permissions
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2-key.pem
          chmod 600 ec2-key.pem
      
      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: 43.200.140.40
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 40m
          script: |
            echo "ğŸ”¹ SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!"
            cd ~/student/boot_react_student
            
            # ğŸ”¹ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            export GIT_SSH_COMMAND="ssh -i ~/.ssh/github-key -o StrictHostKeyChecking=no"
            git pull origin main
            
            # ğŸ”¹ ë°±ì—”ë“œ ë¹Œë“œ ë° ë°°í¬
            cd backend_student
            chmod +x gradlew
            ./gradlew build -x test
            
            # ğŸ”¹ ì‹¤í–‰ ì¤‘ì¸ JAR í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            echo "ğŸ”¹ ì‹¤í–‰ ì¤‘ì¸ JAR í”„ë¡œì„¸ìŠ¤ í™•ì¸ ë° ì¢…ë£Œ"
            if screen -list | grep -q "spring_server"; then
              echo "ğŸ”¹ ê¸°ì¡´ spring_server screen ì„¸ì…˜ ì¢…ë£Œ"
              screen -S spring_server -X quit
            fi
            
            # ê¸°ì¡´ Java í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (PID íŒŒì¼ ì‚¬ìš© ë°©ì‹ ë°±ì—…)
            if [ -f ~/student/backend.pid ]; then
              echo "ğŸ”¹ ê¸°ì¡´ PID íŒŒì¼ë¡œ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹œë„"
              pkill -F ~/student/backend.pid || true
              rm ~/student/backend.pid
            fi
            
            # í”„ë¡œì„¸ìŠ¤ ì´ë¦„ìœ¼ë¡œ ì¢…ë£Œ (ì¶”ê°€ ì•ˆì „ì¥ì¹˜)
            echo "ğŸ”¹ í”„ë¡œì„¸ìŠ¤ëª…ìœ¼ë¡œ ì¢…ë£Œ ì‹œë„"
            pkill -f "java -jar.*student-0.0.1-SNAPSHOT.jar" || true
            
            # ìƒˆ í”„ë¡œì„¸ìŠ¤ ì‹œì‘
            echo "ğŸ”¹ ìƒˆ ë°±ì—”ë“œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘"
            screen -dmS spring_server java -jar build/libs/student-0.0.1-SNAPSHOT.jar --server.port=8080
            sleep 5
            
            # ì‹¤í–‰ í™•ì¸
            echo "ğŸ”¹ ë°±ì—”ë“œ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ í™•ì¸"
            if screen -list | grep -q "spring_server"; then
              echo "ğŸ”¹ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
            else
              echo "âŒ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨"
              exit 1
            fi
            
            echo "ğŸ”¹ ë°±ì—”ë“œ ë°°í¬ ì™„ë£Œ"
            
            # ğŸ”¹ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
            cd ../frontend_student || exit 1
            echo "ğŸ”¹ npm íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œì‘"
            npm install --legacy-peer-deps
            echo "ğŸ”¹ build ì‹œì‘"
            NODE_OPTIONS="--max-old-space-size=2048" npm run build
            echo "ğŸ”¹ build ì¢…ë£Œ"
            
            # ğŸ”¹ Nginx ì •ì  íŒŒì¼ ì—…ë°ì´íŠ¸
            echo "ğŸ”¹ Nginx ì •ì  íŒŒì¼ ì œê±°"
            sudo rm -rf /usr/share/nginx/html/*
            
            echo "ğŸ”¹ í”„ë¡ íŠ¸ dist ë³µì‚¬ ì‹œì‘"
            sudo cp -r dist/* /usr/share/nginx/html/
            echo "ğŸ”¹ ë³µì‚¬ ì™„ë£Œ"
            
            # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ì¬ì‹œì‘
            echo "ğŸ”¹ Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ì¬ì‹œì‘"
            sudo nginx -t && sudo systemctl restart nginx
            echo "ğŸ”¹ ë°°í¬ ì™„ë£Œ!"
